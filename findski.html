<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Find A Ski Area!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/> 
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Google Fonts: Inter, Montserrat, Playfair Display -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-base: 'Montserrat', sans-serif;
      --font-heading: 'Playfair Display', serif;
      --font-toggle: 'Montserrat', sans-serif;

      /* Light-mode colors */
      --bg-controls: rgba(255, 255, 255, 1);
      --text-controls: #000;
      --bg-panel: rgba(255, 255, 255, 0.9);
      --text-panel: #000;
      --bg-infobox: rgba(255, 255, 255, 0.8);
      --text-infobox: #000;
      --popup-bg: #fff;
      --popup-text: #000;
    }

    /* Dark-mode overrides */
    .dark-mode {
      --bg-controls: rgba(0, 0, 0, 1);
      --text-controls: #fff;
      --bg-panel: rgba(0, 0, 0, 0.9);
      --text-panel: #fff;
      --bg-infobox: rgba(0, 0, 0, 0.8);
      --text-infobox: #fff;
      --popup-bg: #000;
      --popup-text: #fff;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: var(--font-base);
      background: #fff;
      color: #000;
    }
    .dark-mode html, .dark-mode body {
      background: #000;
      color: #fff;
    }

    #map { width: 100%; height: 100%; }

    /* Theme Dark or light mode Toggle Container */
    #theme-container {
      position: absolute;
      top: 10px;
      left: 55px;
      width: auto;
      z-index: 1000;
      background: var(--bg-controls);
      padding: 4px 6px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      color: var(--text-controls);
      font-family: var(--font-base);
      font-size: 0.9em;
    }
    .dark-mode #theme-container {
      box-shadow: 0 0 5px rgba(255,255,255,0.3);
    }
    .theme-toggle {
      font-size: 0.9em;
      font-family: var(--font-toggle);
      color: var(--text-controls);
      display: flex;
      align-items: center;
    }
    .theme-toggle input[type="checkbox"] {
      appearance: none;
      width: 16px;
      height: 16px;
      background-color: black;
      cursor: pointer;
      margin-right: 6px;
    }
    .theme-toggle input[type="checkbox"]:checked {
      background-color: white;
    }

    /* Wrapper for Controls and Text Box */
    #controls-wrapper {
      position: absolute;
      top: 81%;
      left: 40%;
      transform: translateX(-30%);
      z-index: 1000;
      width: auto;
    }

    /* Controls (other filters) */
    #controls {
      background: var(--bg-controls);
      padding: 6px 8px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      color: var(--text-controls);
      font-family: var(--font-base);
      width: 100%;
    }
    .dark-mode #controls {
      box-shadow: 0 0 5px rgba(255,255,255,0.3);
    }

    /* New Text Box Below Controls */
    #text-box {
      margin-top: 8px;
      background: var(--bg-controls);
      padding: 6px 8px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      color: var(--text-controls);
      font-family: var(--font-base);
      font-size: 0.9em;
      text-align: left;
      width: 100%;
    }
    .dark-mode #text-box {
      box-shadow: 0 0 5px rgba(255,255,255,0.3);
    }

    .pass-toggle, .price-toggle {
      margin-right: 8px;
      font-size: 0.9em;
      font-family: var(--font-toggle);
      color: var(--text-controls);
    }

    /* Accent colors for each pass checkbox */
    #indy-toggle    { accent-color: red;    }
    #epic-toggle    { accent-color: orange; }
    #ikon-toggle    { accent-color: yellow; }
    #freedom-toggle { accent-color: blue;   }
    #power-toggle   { accent-color: gray;   }

    #address-input {
      width: 160px;
      padding: 4px;
      font-family: var(--font-base);
      background: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 2px;
    }
    .dark-mode #address-input {
      background: #222;
      color: #fff;
      border: 1px solid #555;
    }
    #address-submit {
      padding: 4px 8px;
      margin-right: 12px;
      font-family: var(--font-base);
      background: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 2px;
      cursor: pointer;
    }
    .dark-mode #address-submit {
      background: #333;
      color: #fff;
      border: 1px solid #555;
    }

    /* Results panel */
    #results {
      position: absolute;
      bottom: 2%;
      left: 1%;
      max-height: 300px;
      max-width: 400px;
      overflow-y: auto;
      background: var(--bg-panel);
      padding: 20px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: var(--font-base);
      font-size: 1.05em;
      display: none;
      z-index: 99999;
      color: var(--text-panel);
    }
    .dark-mode #results {
      box-shadow: 0 0 5px rgba(255,255,255,0.3);
    }
    #results h4 {
      margin: 0 0 6px;
      font-family: var(--font-heading);
    }
    #results ol {
      margin: 0;
      padding-left: 20px;
      color: var(--text-panel);
    }

    /* Popups */
    .popup-text, .popup-link {
      font-family: var(--font-base);
      color: var(--popup-text);
    }
    .popup-link { 
      display: block;
      margin-top: 6px;
      font-size: 1.0em;
    }
    .leaflet-popup-content-wrapper {
      background: var(--popup-bg) !important;
      color: var(--popup-text) !important;
    }
    .leaflet-popup-tip {
      background: var(--popup-bg) !important;
    }
    .dark-mode .leaflet-popup-content-wrapper,
    .dark-mode .leaflet-popup-tip {
      background: var(--popup-bg) !important;
    }

    /* Pass info popup */
    #pass-info {
      position: absolute;
      bottom: 2%;
      right: 1%;
      width: 14.5%;
      background: var(--bg-panel);
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: var(--font-base);
      font-size: 1em;
      display: none;
      z-index: 10000;
      color: var(--text-panel);
    }
    .dark-mode #pass-info {
      box-shadow: 0 0 5px rgba(255,255,255,0.3);
    }
    #pass-info h4 {
      margin: 0 0 6px;
      font-size: 1.0em;
      font-family: var(--font-heading);
    }
    #pass-info p {
      margin: 4px 0;
      color: var(--text-panel);
    }
    #pass-info a {
      color: #0074D9;
      text-decoration: none;
      word-break: break-all;
    }

    /* Header Text */
    #info-text {
      position: absolute;
      top: 1%;
      left: 50%;
      transform: translateX(-50%);
      width: 1000px;
      background: var(--bg-infobox);
      padding: 10px;
      border-radius: 4px;
      font-family: var(--font-base);
      font-size: 1em;
      text-align: center;
      line-height: 1.2em;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 10000;
      color: var(--text-infobox);
    }
    .dark-mode #info-text {
      box-shadow: 0 0 5px rgba(255,255,255,0.3);
    }
    #info-text h4 {
      margin: 0 0 4px;
      font-size: 1.4em;
      font-weight: bold;
      font-family: var(--font-heading);
      color: var(--text-infobox);
    }
  </style>
</head>
<body>
  <!-- Theme Toggle (moved to top-left) -->
  <div id="theme-container">
    <label class="theme-toggle">
      <input type="checkbox" id="theme-toggle" />
      <span id="theme-label">Dark Mode 🌙</span>
    </label>
  </div>

  <!-- Controls Wrapper -->
  <div id="controls-wrapper">
    <!-- Controls (other filters) -->
    <div id="controls">
      <!-- Price-Type Filter -->
      <label class="price-toggle">
        <input type="radio" name="price-type" value="day" id="price-day" checked>
        Day Pass
      </label>
      <label class="price-toggle">
        <input type="radio" name="price-type" value="season" id="price-season">
        Season Pass
      </label>
      <label class="price-toggle">
        <input type="radio" name="price-type" value="multiplier" id="price-multiplier">
        Ratio
      </label>

      <input id="address-input" type="text" placeholder="Enter your address here" />
      <button id="address-submit">Go</button>

      <!-- Pass Toggles -->
      <label class="pass-toggle">
        <input type="checkbox" id="indy-toggle" /> <span>Indy Pass</span>
      </label>
      <label class="pass-toggle">
        <input type="checkbox" id="ikon-toggle" /> <span>Ikon Pass</span>
      </label>
      <label class="pass-toggle">
        <input type="checkbox" id="epic-toggle" /> <span>Epic Pass</span>
      </label>
      <label class="pass-toggle">
        <input type="checkbox" id="freedom-toggle" /> <span>Freedom Pass</span>
      </label>
      <label class="pass-toggle">
        <input type="checkbox" id="power-toggle" /> <span>Power Pass</span>
      </label>
    </div>

    <!-- New Text Box Below Controls -->
    <div id="text-box">States currently included: California, Nevada, Arizona, Oregon, Idaho, Washington, and Alaska. Ski areas are included on the map if they have at least one conventional ski lift (exception for the buses at Moose Mountain in Alaska). Passes are based on pricing for a 30 year-old adult without special status (veteran, college student, etc). Day passes are based on a standard, entire non-holiday weekday purchased one week in advance and season passes are based on the cheapest available pass with no blackout dates. Note: Some ski resorts do not offer their own season passes but rather only are available with unlimited access as part of a multi-resort pass like Northstar California Resort on the Ikon Pass. In such cases, the price of the multi-resort pass is used. Prices are sourced from individual resorts and onthesnow.com where necessary.</div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Results -->
  <div id="results">
    <h4>Closest Resorts to You (By Drive Time)</h4>
    <ol id="results-list"></ol>
  </div>

  <!-- Pass Info Panel -->
  <div id="pass-info"></div>

  <!-- Bottom-left Info Text -->
  <div id="info-text">
    <h4 style="text-align: center;">Find The Ski Area For You (Western United States)</h4>
    <h4 style="text-align: center;"> </h4>Created by Rory Forsythe-Elder. This website is optimized for laptop/desktop viewing. Last updated June 3, 2025. <br>
  </div>

  <script>
    const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1Ijoicm9yeTRzeXRoZWxkZXIiLCJhIjoiY205MXV2eXh1MDUxejJqb2VyOXlqcHduMSJ9.jayP103_JPGAKudstFC6Zw';

    // Define the approximate bounding box for all USA (west = Aleutians, east = East Coast)
    const southWest = [0, -170];
    const northEast = [72, -66];
    const usaBounds = L.latLngBounds(southWest, northEast);

    // Initialize map with minZoom and maxBounds
    const map = L.map('map', {
      center: [46.5, -120.0],
      zoom: 4,
      minZoom: 4,
      maxBounds: usaBounds,
      maxBoundsViscosity: 1.0
    });

    // Define base layers
    const lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });
    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors & CartoDB'
    });

    // Add the light layer by default
    lightLayer.addTo(map);

    // pass membership lists
    const ikonNames = [
      "Palisades Tahoe","Sierra-at-Tahoe Resort","Mammoth Mountain",
      "June Mountain","Big Bear Mountain Resort","Snow Valley Mountain Resort",
      "Mt. Bachelor","Crystal Mountain","The Summit at Snoqualmie","Schweitzer Mountain","Sun Valley", "Alyeska Resort"
    ];
    const epicNames = [
      "Northstar California Resort","Stevens Pass",
      "Heavenly Mountain Resort","Kirkwood Mountain Resort"
    ];
    const freedomNames = [
      "Mt. Ashland Ski Area","Mount Spokane", "Bogus Basin", "Eaglecrest Ski Area"
    ];
    const indyNames = [
      "Hoodoo Ski Area","Cooper Spur Ski Area","Mt. Hood Meadows",
      "Ski Bluewood","White Pass","Hurricane Ridge","49° North Mountain Resort",
      "Loup Loup Ski Bowl","Mission Ridge","Mount Shasta Ski Park",
      "China Peak Mountain Resort","Mountain High Resort",
      "Dodge Ridge Mountain Resort","Bear Valley Mountain Resort", 
      "Sunrise Park Resort", "Silver Mountain", "Brundage Mountain", "Tamarack", 
      "Soldier Mountain", "Pomerelle", "Kelly Canyon","Moose Mountain","Arctic Valley","Mount Eyak"
    ];
    const powerNames = [
      "Willamette Pass Resort", "Lee Canyon", "Arizona Snowbowl"
    ];

    // build a DivIcon with snowflake + floating price/ratio label
    function getSnowIcon(borderColor = '', labelText = '') {
      const innerBorder = borderColor ? 4 : 0;
      const size = 20 + innerBorder * 2;
      return L.divIcon({
        html: `
          <div style="
            position: relative;
            width: ${size}px;
            height: ${size + 14}px;
            display: flex;
            flex-direction: column;
            align-items: center;
          ">
            <!-- label uses Montserrat now -->
            <div style="
              position: absolute;
              top: 0;
              left: 50%;
              transform: translateX(-50%);
              font-size: 10px;
              font-family: var(--font-toggle);
              background: var(--bg-panel);
              color: var(--text-panel);
              padding: 1px 3px;
              border-radius: 2px;
              box-shadow: 0 0 2px rgba(0,0,0,0.3);
            ">${labelText}</div>
            <div style="
              margin-top: 14px;
              width: ${size}px;
              height: ${size}px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 20px;
              color: red;
              ${borderColor ? `border: ${innerBorder}px solid ${borderColor}; box-shadow: 0 0 0 2px black;` : ''}
              border-radius: 50%;
              background: var(--popup-bg);
            ">
              ❄️
            </div>
          </div>
        `,
        className: '',
        iconSize: [size, size + 14],
        iconAnchor: [size / 2, (size + 14) / 2]
      });
    }

    const skiResortsWithMarkers = [];
    let redRoutes = [];

    // full list with dayPass & seasonPass
    const skiResorts = [
      // — Oregon —
      { name:"Mt. Hood Skibowl", lat:45.30189, lon:-121.773212, dayUrl:"https://skibowl.com/tickets-passes/daily-lift-tickets/", seasonUrl:"https://skibowl.com/tickets-passes/season-passes/", seasonPass:689,  dayPass:149 },
      { name:"Mt. Hood Meadows", lat:45.32889, lon:-121.66250,  dayUrl:"https://www.skihood.com/store/tickets-and-passes",              seasonUrl:"https://www.skihood.com/store/tickets-and-passes",      seasonPass:479,  dayPass:59  },
      { name:"Timberline Lodge", lat:45.33111, lon:-121.71000,  dayUrl:"https://tickets.timberlinelodge.com/", seasonUrl:"https://www.timberlinelodge.com/mountain/season-passes?",                seasonPass:1149, dayPass:114 },
      { name:"Cooper Spur Ski Area", lat:45.412218, lon:-121.605329, dayUrl:"https://cooperspur.com/downhill-riding/",                 seasonUrl:"https://cooperspur.com/downhill-riding/",               seasonPass:269,  dayPass:52  },
      { name:"Hoodoo Ski Area", lat:44.40900, lon:-121.87200,  dayUrl:"https://skihoodoo.com/rates/lift-tickets/",                        seasonUrl:"https://skihoodoo.com/rates/season-passes/",           seasonPass:749,  dayPass:75  },
      { name:"Willamette Pass Resort", lat:43.600964, lon:-122.036115, dayUrl:"https://www.willamettepass.com/tickets/",              seasonUrl:"https://www.willamettepass.ski/season-passes/",         seasonPass:599, dayPass:29  },
      { name:"Mt. Bachelor", lat:43.97430, lon:-121.68640,  dayUrl:"https://www.mtbachelor.com/",            seasonUrl:"https://shop.mtbachelor.com/full-season-passes",       seasonPass:1449, dayPass:194 },
      { name:"Mt. Ashland Ski Area", lat:42.08333, lon:-122.71667,  dayUrl:"https://www.mtashland.com/lift-tickets/",                  seasonUrl:"https://www.mtashland.com/season-passes/",             seasonPass:624,  dayPass:79  },
      { name:"Anthony Lakes Ski Area", lat:44.96409, lon:-118.234482, dayUrl:"https://anthonylakes.com/winter/day-tickets/",          seasonUrl:"https://anthonylakes.com/season-passes/",             seasonPass:525,  dayPass:50  },
      { name:"Warner Canyon Ski Area", lat:42.23749, lon:-120.29583,  dayUrl:"https://warnercanyonski.com/buy",                     seasonUrl:"https://warnercanyonski.com/buy",         seasonPass:350, dayPass:35 },

      // — Washington —
      { name:"49° North Mountain Resort", lat:48.30100, lon:-117.56300, dayUrl:"https://www.ski49n.com/tickets/day-tickets", seasonUrl:"https://www.ski49n.com/tickets/season-passes", seasonPass:549,  dayPass:47  },
      { name:"Ski Bluewood", lat:46.08200, lon:-117.85100, dayUrl:"https://bluewood.com/tickets",                    seasonUrl:"https://www.bluewood.com/25-26-season-pass",           seasonPass:699,  dayPass:59  },
      { name:"Crystal Mountain", lat:46.9282, lon:-121.5045, dayUrl:"https://www.crystalmountainresort.com/plan-your-trip/tickets-and-passes/day-tickets/", seasonUrl:"https://www.crystalmountainresort.com/plan-your-trip/tickets-and-passes/season-passes/", seasonPass:849, dayPass:149 },
      { name:"Hurricane Ridge", lat:47.97100, lon:-123.49300, dayUrl:"https://www.hurricaneridge.com/tickets-and-passes/",                      seasonUrl:"https://www.hurricaneridge.com/tickets-and-passes/",                      seasonPass:369, dayPass:57 },
      { name:"Loup Loup Ski Bowl", lat:48.39472, lon:-119.91278, dayUrl:"https://skitheloup.org/plan-your-visit/passes-tickets/",                          seasonUrl:"https://skitheloup.org/plan-your-visit/passes-tickets/",         seasonPass:615, dayPass:70 },
      { name:"Mission Ridge", lat:47.29200, lon:-120.39900, dayUrl:"https://www.missionridge.com/tickets",                seasonUrl:"https://www.missionridge.com/season-passes",          seasonPass:939,  dayPass:99  },
      { name:"Mt. Baker Ski Area", lat:48.86200, lon:-121.65400, dayUrl:"https://www.mtbaker.us/tickets-and-passes/daily-lift-tickets/", seasonUrl:"https://www.mtbaker.us/tickets-and-passes/2025-26-mt-baker-season-passes/",            seasonPass:1102, dayPass:91 },
      { name:"Mount Spokane", lat:47.92200, lon:-117.09700, dayUrl:"https://www.mtspokane.com/lift-tickets",                           seasonUrl:"https://www.mtspokane.com/",                          seasonPass:849,  dayPass:60  },
      { name:"Sitzmark Ski Area", lat:48.86500, lon:-119.16400, dayUrl:"https://www.facebook.com/SitzmarkSkiArea",             seasonUrl:"https://www.facebook.com/SitzmarkSkiArea",            seasonPass:null, dayPass:null },
      { name:"Stevens Pass", lat:47.74500, lon:-121.09330, dayUrl:"https://www.stevenspass.com/tickets",                 seasonUrl:"https://www.stevenspass.com/seasons-passes",          seasonPass:949,  dayPass:120 },
      { name:"The Summit at Snoqualmie", lat:47.42400, lon:-121.41600, dayUrl:"https://www.summitatsnoqualmie.com/lift-tickets",          seasonUrl:"https://www.summitatsnoqualmie.com/season-passes", seasonPass:699,  dayPass:83  },
      { name:"White Pass", lat:46.6387,   lon:-121.3895, dayUrl:"https://skiwhitepass.com/the-mountain/lift-tickets", seasonUrl:"https://skiwhitepass.com/the-mountain/season-passes", seasonPass:799,  dayPass:85  },

      // — California —
      { name:"Palisades Tahoe", lat:39.19720, lon:-120.23810,  dayUrl:"https://www.palisadestahoe.com/plan-your-visit/lift-tickets-season-pass", seasonUrl:"https://www.palisadestahoe.com/plan-your-visit/lift-tickets-season-pass", seasonPass:1449, dayPass:289 },
      { name:"Mammoth Mountain", lat:37.64858, lon:-118.97210,  dayUrl:"https://www.mammothmountain.com/plan-your-trip/tickets/winter-lift-tickets", seasonUrl:"https://www.mammothmountain.com/plan-your-trip/season-passes", seasonPass:1329, dayPass:219 },
      { name:"Heavenly Mountain Resort", lat:38.93506, lon:-119.93974,  dayUrl:"https://www.skiheavenly.com/plan-your-trip/lift-access/tickets.aspx", seasonUrl:"https://www.skiheavenly.com/plan-your-trip/lift-access/passes.aspx", seasonPass:707,  dayPass:232 },
      { name:"Kirkwood Mountain Resort", lat:38.68475, lon:-120.06540,  dayUrl:"https://www.kirkwood.com/plan-your-trip/lift-access/tickets.aspx", seasonUrl:"https://www.kirkwood.com/plan-your-trip/lift-access/passes.aspx", seasonPass:679,  dayPass:143 },
      { name:"Northstar California Resort", lat:39.27340, lon:-120.13460,  dayUrl:"https://www.northstarcalifornia.com/plan-your-trip/lift-access/tickets.aspx", seasonUrl:"https://www.northstarcalifornia.com/plan-your-trip/lift-access/passes.aspx", seasonPass:1075, dayPass:237 },
      { name:"Sugar Bowl Resort", lat:39.33180, lon:-120.30920,  dayUrl:"https://www.sugarbowl.com/tickets", seasonUrl:"https://www.sugarbowl.com/seasonpass", seasonPass:1299,  dayPass:162 },
      { name:"Sierra-at-Tahoe Resort", lat:38.81250, lon:-120.11960,  dayUrl:"https://www.sierraattahoe.com/lift-tickets/", seasonUrl:"https://www.sierraattahoe.com/season-passes/", seasonPass:649,  dayPass:145 },
      { name:"June Mountain", lat:37.78750, lon:-119.03450,  dayUrl:"https://www.junemountain.com/plan-your-trip/lift-tickets", seasonUrl:"https://www.junemountain.com/plan-your-trip/season-passes", seasonPass:729, dayPass:139 },
      { name:"Bear Valley Mountain Resort", lat:38.13580, lon:-119.62500,  dayUrl:"https://www.bearvalley.com/tickets", seasonUrl:"https://www.bearvalley.com/season-passes", seasonPass:629,  dayPass:89 },
      { name:"Dodge Ridge Mountain Resort", lat:37.84550, lon:-119.80880,  dayUrl:"https://dodgeridge.com/lift-tickets/", seasonUrl:"https://dodgeridge.com/winter-tickets-passes/", seasonPass:629,  dayPass:129 },
      { name:"China Peak Mountain Resort", lat:37.38440, lon:-119.38900,  dayUrl:"https://www.skichinapeak.com/lift-tickets", seasonUrl:"https://skichinapeak.com/season-passes", seasonPass:629,  dayPass:111 },
      { name:"Homewood Mountain Resort", lat:38.96490, lon:-120.10660,  dayUrl:"https://skihomewood.com/tickets/", seasonUrl:"https://shop.skihomewood.com/s/season-passes/", seasonPass:999,  dayPass:104 },
      { name:"Mount Shasta Ski Park", lat:41.31020, lon:-122.32780,  dayUrl:"https://www.skipark.com/winter/lift-tickets-1", seasonUrl:"https://www.skipark.com/winter/season-passes", seasonPass:499,  dayPass:99  },
      { name:"Badger Pass Ski Area", lat:37.73310, lon:-119.63700,  dayUrl:"https://www.travelyosemite.com/winter/badger-pass-ski-area/downhill-skiing-snowboarding", seasonUrl:"https://www.travelyosemite.com/winter/badger-pass-ski-area/season-passes-discounts", seasonPass:500,  dayPass:64  },
      { name:"Donner Ski Ranch", lat:39.30340, lon:-120.30350,  dayUrl:"https://www.donnerskiranch.com/pricing", seasonUrl:"https://www.donnerskiranch.com/season-passes", seasonPass:549,  dayPass:109 },
      { name:"Boreal Mountain Resort", lat:39.33130, lon:-120.27760,  dayUrl:"https://www.rideboreal.com/day-access/tickets/go-time-lift-tickets/", seasonUrl:"https://www.rideboreal.com/passes-memberships/passes-memberships-overview/comparison/", seasonPass:609,  dayPass:139 },
      { name:"Soda Springs Mountain Resort", lat:39.30340, lon:-120.30390,  dayUrl:"https://www.skisodasprings.com/plan-your-trip/tickets-passes/tickets-passes-soda-springs/", seasonUrl:"https://www.skisodasprings.com/plan-your-trip/tickets-passes/unlimited-pass/", seasonPass:259,  dayPass:119 },
      { name:"Tahoe Donner Downhill Ski Area", lat:39.32480, lon:-120.22090, dayUrl:"https://www.tahoedonner.com/amenities/amenities/downhill-ski/tickets-passes-rental/day-tickets/", seasonUrl:"https://www.tahoedonner.com/amenities/amenities/downhill-ski/tickets-passes-rental/season-passes/", seasonPass:773,  dayPass:54  },
      { name:"Big Bear Mountain Resort", lat:34.23630, lon:-116.85620,  dayUrl:"", seasonUrl:"", seasonPass:null, dayPass:null },
      { name:"Snow Summit", lat:34.25600, lon:-117.03020,  dayUrl:"", seasonUrl:"", seasonPass:null, dayPass:null },
      { name:"Snow Valley Mountain Resort", lat:34.28240, lon:-117.17740,  dayUrl:"", seasonUrl:"", seasonPass:null, dayPass:null },
      { name:"Mountain High Resort", lat:34.30940, lon:-117.69010,  dayUrl:"", seasonUrl:"", seasonPass:849,  dayPass:119 },
      { name:"Mt. Baldy Resort", lat:34.23620, lon:-117.65620,  dayUrl:"", seasonUrl:"", seasonPass:599,  dayPass:69 },
      { name:"Mount Waterman", lat:34.27640, lon:-118.17690,  dayUrl:"", seasonUrl:"", seasonPass:null, dayPass:null },
      { name:"Buckhorn Ski and Snowboard Club", lat:37.79850, lon:-120.06840, dayUrl:"", seasonUrl:"", seasonPass:null, dayPass:null },
      { name:"Alta Sierra at Shirley Meadows", lat:36.09560, lon:-118.40620, dayUrl:"", seasonUrl:"", seasonPass:null, dayPass:null },
      { name:"Coppervale Ski Area", lat:39.77620, lon:-120.47220,  dayUrl:"", seasonUrl:"", seasonPass:null, dayPass:null },

      // Nevada
      { name:"Lee Canyon", lat:36.301638, lon:-115.680759,  dayUrl:"https://www.leecanyonlv.com/winter-lift-ticket/", seasonUrl:"https://www.leecanyonlv.com/season-pass/", seasonPass:749, dayPass:59 },
      { name:"Mount Rose", lat:39.329167, lon:-119.885833,  dayUrl:"https://skirose.com/lift-tickets/", seasonUrl:"https://skirose.com/season-passes/", seasonPass:975, dayPass:165 },
      { name:"Diamond Peak", lat:39.254, lon:-119.924,  dayUrl:"https://www.diamondpeak.com/tickets-passes-rentals/lift-tickets/", seasonUrl:"https://www.diamondpeak.com/tickets-passes-rentals/season-passes/", seasonPass:588, dayPass:130 },
      { name:"Sky Tavern", lat:39.3365761, lon:-119.8735225,  dayUrl:"https://www.shopskytavern.org/index.php", seasonUrl:"https://www.shopskytavern.org/index.php", seasonPass:null, dayPass:null },
      { name:"Elko Sno Bowl", lat:40.9091, lon:-115.8524,  dayUrl:"https://google.com", seasonUrl:"https://google.com", seasonPass:null, dayPass:50 },

      // Arizona
      { name:"Arizona Snowbowl", lat:35.330, lon:-111.705,  dayUrl:"https://www.snowbowl.ski/lift-tickets/", seasonUrl:"https://www.snowbowl.ski/plan-your-trip/season-passes/", seasonPass:749, dayPass:19 },
      { name:"Mt. Lemmon Ski Valley", lat:32.452222, lon:-110.783889,  dayUrl:"https://www.skithelemmon.com/new-page-1", seasonUrl:"https://google.com", seasonPass:null, dayPass:73 },
      { name:"Sunrise Park Resort", lat:33.973333, lon:-109.564722,  dayUrl:"https://www.sunrise.ski/winter/day-passes/", seasonUrl:"https://www.sunrise.ski/winter/tickets/", seasonPass:729, dayPass:77 },

      // Idaho
      { name:"Bald Mountain", lat:43.654847, lon:-114.409368, dayUrl:"https://skibaldmountain.com/tickets/", seasonUrl:"https://skibaldmountain.com/tickets/", seasonPass:null, dayPass:25 }, 
      { name:"Bogus Basin", lat:43.76468, lon:-116.10329, dayUrl:"https://bogusbasin.org/tickets-passes/winter-tickets/#accordion-snowboarding-alpine-skiing", seasonUrl:"https://bogusbasin.org/tickets-passes/season-passes/", seasonPass:649, dayPass:84 }, 
      { name:"Brundage Mountain", lat:45.0036, lon:-116.1597, dayUrl:"https://brundage.com/daily-lift-tickets", seasonUrl:"https://brundage.com/season-passes", seasonPass:899, dayPass:95 }, 
      { name:"Kelly Canyon", lat:43.63932793, lon:-111.6166865, dayUrl:"https://www.kellycanyonresort.com/ski/", seasonUrl:"https://www.kellycanyonresort.com/ski/", seasonPass:1099, dayPass:45 },
      { name:"Lookout Pass", lat:47.4549307, lon:-115.6968233, dayUrl:"https://skilookout.com/lift-tickets", seasonUrl:"https://skilookout.com/season-pass", seasonPass:549, dayPass:58 }, 
      { name:"Pebble Creek", lat:42.7757493, lon:-112.1527444, dayUrl:"https://pebblecreekskiarea.com/tickets-passes/", seasonUrl:"https://pebblecreekskiarea.com/tickets-passes/", seasonPass:858, dayPass:83 }, 
      { name:"Pomerelle", lat:42.31213, lon:-113.61195, dayUrl:"https://www.pomerelle.com/reload", seasonUrl:"https://www.pomerelle.com/season-passes", seasonPass:599, dayPass:53 }, 
      { name:"Schweitzer Mountain", lat:48.380368, lon:-116.633828, dayUrl:"https://www.schweitzer.com/plan-your-trip/tickets-and-passes", seasonUrl:"https://www.schweitzer.com/plan-your-trip/tickets-and-passes", seasonPass:1139, dayPass:120 }, 
      { name:"Silver Mountain", lat:47.64108, lon:-116.11296, dayUrl:"https://silvermt.com/tickets", seasonUrl:"https://silvermt.com/tickets", seasonPass:609, dayPass:68 }, 
      { name:"Soldier Mountain", lat:43.483, lon:-114.833, dayUrl:"https://soldiermountain.com/tickets-passes/", seasonUrl:"https://soldiermountain.com/tickets-passes/", seasonPass:449, dayPass:59 }, 
      { name:"Sun Valley", lat:43.6954, lon:-114.3539, dayUrl:"https://www.sunvalley.com/tickets-passes/lift-tickets/", seasonUrl:"https://www.sunvalley.com/tickets-passes/season-passes/", seasonPass:2979, dayPass:242 }, 
      { name:"Tamarack", lat:44.7038104, lon:-116.1658189, dayUrl:"https://tamarackidaho.com/activities/lift-tickets", seasonUrl:"https://tamarackidaho.com/activities/boundless-pass", seasonPass:599, dayPass:88 }, 

      // Alaska
      { name:"Arctic Valley",           lat:61.246728,    lon:-149.534508,    dayUrl:"https://arcticvalley.org/product-category/lift-tickets/", seasonUrl:"https://arcticvalley.org/product-category/membership/season-passes/", seasonPass:475, dayPass:49 }, 
      { name:"Alyeska Resort",          lat:60.9705,      lon:-149.0982,      dayUrl:"https://www.alyeskaresort.com/product/lift-tickets/", seasonUrl:"https://www.alyeskaresort.com/season-passes/", seasonPass:1549, dayPass:109 },
      { name:"Eaglecrest Ski Area",     lat:58.2723,      lon:-134.5092,      dayUrl:"https://skieaglecrest.com/lift-tickets/", seasonUrl:"https://skieaglecrest.com/season-passes/", seasonPass:870, dayPass:75 }, 
      { name:"Hilltop Ski Area",        lat:61.1410479,   lon:-149.738648143671, dayUrl:"https://www.hilltopskiarea.org/plan-your-visit/ticket-info/", seasonUrl:"https://www.hilltopskiarea.org/plan-your-visit/ticket-info/", seasonPass:610, dayPass:41 },
      { name:"Mount Eyak",              lat:60.54278,     lon:-145.7575,      dayUrl:"https://google.com", seasonUrl:"https://google.com", seasonPass:null, dayPass:null },
      { name:"Ski Land",                lat:65.068521,    lon:-147.443936,    dayUrl:"https://skilandfairbanks.com/rates/", seasonUrl:"https://skilandfairbanks.com/passes/", seasonPass:625, dayPass:55 },
      { name:"Moose Mountain",          lat:64.9406,      lon:-147.9906,      dayUrl:"https://shredthemoose.com/passes-tickets-2/", seasonUrl:"https://shredthemoose.com/passes-tickets-2/", seasonPass:null, dayPass:55 } 
    ];

    // add markers
    skiResorts.forEach(r => {
      const entry = { resort: r };
      skiResortsWithMarkers.push(entry);
    });

    // refresh all icons based on toggles & price-type
    function refreshIcons() {
      const ikonOn    = document.getElementById('ikon-toggle').checked;
      const epicOn    = document.getElementById('epic-toggle').checked;
      const freedomOn = document.getElementById('freedom-toggle').checked;
      const indyOn    = document.getElementById('indy-toggle').checked;
      const powerOn   = document.getElementById('power-toggle').checked;
      const priceType = document.querySelector('input[name="price-type"]:checked').value;

      // remove existing markers
      skiResortsWithMarkers.forEach(e => {
        if (e.marker) map.removeLayer(e.marker);
      });

      // re-add with updated icon
      skiResortsWithMarkers.forEach(e => {
        const r = e.resort;
        let border = '';
        if (ikonOn    && ikonNames.includes(r.name))    border = 'yellow'; 
        if (epicOn    && epicNames.includes(r.name))    border = 'orange';
        if (freedomOn && freedomNames.includes(r.name)) border = 'blue';
        if (indyOn    && indyNames.includes(r.name))    border = 'red';
        if (powerOn   && powerNames.includes(r.name))   border = 'gray';

        let raw;
        if (priceType === 'day') {
          raw = r.dayPass;
        } else if (priceType === 'season') {
          raw = r.seasonPass;
        } else {
          raw = (r.seasonPass !== null && r.dayPass !== null && r.dayPass > 0)
                ? (r.seasonPass / r.dayPass).toFixed(2)
                : null;
        }

        let labelText;
        if (priceType === 'multiplier') {
          labelText = raw !== null ? raw : 'NULL';
        } else {
          labelText = raw !== null ? '$' + raw.toLocaleString() : 'NULL';
        }

        const icon = getSnowIcon(border, labelText);

        e.marker = L.marker([r.lat, r.lon], { icon })
                    .bindPopup(`
                      <strong>${r.name}</strong>
                      <div class="popup-text">Season Pass: ${r.seasonPass !== null ? '$' + r.seasonPass.toLocaleString() : 'NULL'}</div>
                      <div class="popup-text">Day Pass:   ${r.dayPass    !== null ? '$' + r.dayPass.toLocaleString()    : 'NULL'}</div>
                      <div class="popup-text">Day to Season Ratio: ${r.seasonPass !== null && r.dayPass !== null && r.dayPass > 0 ? (r.seasonPass / r.dayPass).toFixed(2) : 'NULL'}</div>
                      <a class="popup-link" href="${r.dayUrl}"    target="_blank">Buy Day Pass</a>
                      <a class="popup-link" href="${r.seasonUrl}" target="_blank">Buy Season Pass</a>
                    `)
                    .addTo(map);
      });
    }

    // initial render
    refreshIcons();

    // bind toggles
    ['ikon-toggle','epic-toggle','freedom-toggle','indy-toggle','power-toggle']
      .forEach(id => document.getElementById(id).addEventListener('change', () => {
        refreshIcons();
        updatePassInfo();
      }));
    document.querySelectorAll('input[name="price-type"]')
      .forEach(radio => radio.addEventListener('change', refreshIcons));

    // pass info panel
    function updatePassInfo() {
      const info = document.getElementById('pass-info');
      let html = '';
      if (document.getElementById('indy-toggle').checked) {
        html += `<h4>Indy Pass</h4>
                 <p>For $369, the Indy Pass offers two days each across 230+ ski destinations across the United States, Canada, Europe and Japan. Popular resorts include Big White, Loveland, and Mount Shasta. <br> Learn more at <a href="https://www.indyskipass.com/" target="_blank">indyskipass.com</a>.</p>`;
      }
      if (document.getElementById('ikon-toggle').checked) {
        html += `<h4>Ikon Pass</h4>
                 <p>For $1,429, the Ikon Pass gives unlimited access to 18 resorts and up to 7 days of skiing at 41 additional resorts. Popular resorts include Aspen, Big Bear, and Jackson Hole. <br> Learn more at <a href="https://www.ikonpass.com/" target="_blank">ikonpass.com</a>.</p>`;
      }
      if (document.getElementById('epic-toggle').checked) {
        html += `<h4>Epic Pass</h4>
                 <p>For $1,051, the Epic Pass gives unlimited access to 42 resorts owned and operated by Vail Resorts, as well as limited access to dozens partner resorts, across North America, Europe, and Australia. Popular resorts include Vail, Park City, and Heavenly. <br> Learn more at <a href="https://www.epicpass.com/" target="_blank">epicpass.com</a>.</p>`;
      }
      if (document.getElementById('freedom-toggle').checked) {
        html += `<h4>Freedom Pass</h4>
                 <p>With purchase of a season pass at participating resorts, the Freedom Pass gives access to 22 resorts. Popular resorts include Mount Ashland, Mount Spokane, and Bogus Basin. <br> Learn more at <a href="https://skifreedompass.com/" target="_blank">skifreedompass.com</a>.</p>`;
      }
      if (document.getElementById('power-toggle').checked) {
        html += `<h4>Power Pass</h4>
                 <p>For $649, receive unlimited skiing at nine resorts without blackout dates. Popular resorts include Purgatory, Nordic Valley, and Lee Canyon near Las Vegas. <br> Learn more at <a href="https://www.thepowerpass.ski/" target="_blank">thepowerpass.ski</a>.</p>`;
      }
      if (html) {
        info.innerHTML = html;
        info.style.display = 'block';
      } else {
        info.style.display = 'none';
      }
    }

    // haversine & routing
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371, toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    document.getElementById('address-submit').onclick = async () => {
      const addr = document.getElementById('address-input').value.trim();
      if (!addr) return alert('Please enter an address.');
      const geo = await fetch(
        `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(addr)}.json` +
        `?limit=1&access_token=${MAPBOX_ACCESS_TOKEN}`
      ).then(r => r.json());
      if (!geo.features.length) return alert('Address not found.');

      const [userLon, userLat] = geo.features[0].center;
      const nearest = skiResorts
        .map(r => ({ ...r, dist: haversine(userLat, userLon, r.lat, r.lon) }))
        .sort((a,b) => a.dist - b.dist).slice(0,24);

      const coords = [ `${userLon},${userLat}`, ...nearest.map(r => `${r.lon},${r.lat}`) ].join(';');
      const mat = await fetch(
        `https://api.mapbox.com/directions-matrix/v1/mapbox/driving/${coords}` +
        `?sources=0&destinations=${nearest.map((_,i)=>i+1).join(';')}` +
        `&annotations=duration&access_token=${MAPBOX_ACCESS_TOKEN}`
      ).then(r => r.json());
      if (!mat.durations) return alert('Routing failed.');

      nearest.forEach((r,i) => r.driveTime = mat.durations[0][i]);
      const top10 = nearest.sort((a,b) => a.driveTime - b.driveTime).slice(0,10);

      const resultsDiv = document.getElementById('results'),
            list = document.getElementById('results-list');
      list.innerHTML = '';
      top10.forEach(r => {
        const mins = Math.round(r.driveTime/60);
        const li = document.createElement('li');
        li.textContent = `${r.name} — ${mins} min drive`;
        list.appendChild(li);
      });
      resultsDiv.style.display = 'block';

      map.setView([userLat, userLon], 8);
      L.marker([userLat, userLon], {
        icon: L.icon({
          iconUrl: 'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2.png',
          iconSize: [27, 43],
          iconAnchor: [13, 41],
          popupAnchor: [0, -40]
        })
      }).bindPopup('Your location').addTo(map).openPopup();

      redRoutes.forEach(line => map.removeLayer(line));
      redRoutes = [];

      for (const r of top10) {
        const routeResp = await fetch(
          `https://api.mapbox.com/directions/v5/mapbox/driving/${userLon},${userLat};${r.lon},${r.lat}` +
          `?geometries=geojson&access_token=${MAPBOX_ACCESS_TOKEN}`
        ).then(res => res.json());
        if (routeResp.routes && routeResp.routes.length) {
          const coordsArr = routeResp.routes[0].geometry.coordinates.map(([lon,lat]) => [lat,lon]);
          const line = L.polyline(coordsArr, { color: 'red', weight: 3 }).addTo(map);
          redRoutes.push(line);
        }
      }
    };

    document.getElementById('address-input')
      .addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('address-submit').click(); });

    // Theme toggle handler
    document.getElementById('theme-toggle').addEventListener('change', function() {
      const isDark = this.checked;
      const label = document.getElementById('theme-label');

      if (isDark) {
        document.body.classList.add('dark-mode');
        map.removeLayer(lightLayer);
        darkLayer.addTo(map);
        label.textContent = 'Light Mode 🌞';
      } else {
        document.body.classList.remove('dark-mode');
        map.removeLayer(darkLayer);
        lightLayer.addTo(map);
        label.textContent = 'Dark Mode 🌙';
      }
    });
  </script>
</body>
</html>
